<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>6.&nbsp;Jenkins DSL Pipeline (Kubernetes)</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="multi_spring-cloud-pipelines.html" title="Spring Cloud Pipelines"><link rel="up" href="multi_spring-cloud-pipelines.html" title="Spring Cloud Pipelines"><link rel="prev" href="multi_jenkins-dsl-pipeline-cf.html" title="5.&nbsp;Jenkins DSL Pipeline (Cloud Foundry)"><link rel="next" href="multi__the_demo_setup.html" title="7.&nbsp;The demo setup"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">6.&nbsp;Jenkins DSL Pipeline (Kubernetes)</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="multi_jenkins-dsl-pipeline-cf.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="multi__the_demo_setup.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="jenkins-dsl-pipeline-k8s" href="#jenkins-dsl-pipeline-k8s"></a>6.&nbsp;Jenkins DSL Pipeline (Kubernetes)</h1></div></div></div><p><a name="jenkins" href="#jenkins"></a> The repository contains job definitions and the opinionated setup pipeline using <a class="link" href="https://wiki.jenkins-ci.org/display/JENKINS/Job+DSL+Plugin" target="_top">Jenkins Job Dsl plugin</a>. Those jobs will form an empty pipeline and a sample, opinionated one that you can use in your company.</p><p>All in all there are the following projects taking part in the whole <code class="literal">microservice setup</code> for this demo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes" target="_top">Github-Analytics</a> - the app that has a REST endpoint and uses messaging. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a> - project that emits messages that are used by Github Analytics. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Eureka</a> - simple Eureka Server. This is an infrastructure application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Analytics Stub Runner Boot</a> - Stub Runner Boot server to be used for tests with Github Analytics. Uses Eureka and Messaging. This is an infrastructure application.</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="step-by-step-k8s" href="#step-by-step-k8s"></a>6.1&nbsp;Step by step</h2></div></div></div><p>This is a guide for Jenkins JOB Dsl based pipeline.</p><p>If you want to just run the demo as far as possible using PCF Dev and Docker Compose</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="multi_jenkins-dsl-pipeline-k8s.html#jenkins-fork-k8s">Fork repos</a></li><li class="listitem"><a class="link" href="multi_jenkins-dsl-pipeline-k8s.html#jenkins-start-k8s">Start Jenkins and Artifactory</a></li><li class="listitem"><a class="link" href="multi_jenkins-dsl-pipeline-k8s.html#jenkins-deploy-k8s">Deploy infra to Artifactory</a></li><li class="listitem"><a class="link" href="">Start Minikube (if you don&#8217;t want to use an existing one)</a></li><li class="listitem"><a class="link" href="">Run the seed job</a></li><li class="listitem"><a class="link" href="">Run the <code class="literal">github-webhook</code> pipeline</a></li></ul></div><p>Below you can find <a class="link" href="">optional</a> steps needed to be taken when you want to customize the pipeline</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="">Setup Jenkins env vars (if you want to use the demo defaults and you&#8217;re using Docker Machine
just check out the section on how to update the URL to Artifactory)</a></li><li class="listitem"><a class="link" href="">Add <code class="literal">settings.xml</code> for Jenkins' master (you can skip this if you want to use our defaults)</a></li><li class="listitem"><a class="link" href="">Setup Jenkins miscs (JDK installation, Groovy macro processing etc.)</a></li><li class="listitem"><a class="link" href="">Setup Jenkins credentials</a></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fork-repos-k8s" href="#fork-repos-k8s"></a>6.1.1&nbsp;Fork repos</h3></div></div></div><p><a name="jenkins-fork-k8s" href="#jenkins-fork-k8s"></a> There are 4 apps that are composing the pipeline</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github Analytics</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Github Eureka</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot-classpath-stubs" target="_top">Github Stub Runner Boot</a></li></ul></div><p>You need to fork only these. That&#8217;s because only then will your user be able to tag and push the tag to repo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github Analytics</a></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="start-jenkins-k8s" href="#start-jenkins-k8s"></a>6.1.2&nbsp;Start Jenkins and Artifactory</h3></div></div></div><p><a name="jenkins-start-k8s" href="#jenkins-start-k8s"></a> Jenkins + Artifactory can be ran locally. To do that just execute the
<code class="literal">start.sh</code> script from this repo.</p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/jenkins
./start.sh yourGitUsername yourGitPassword yourForkedGithubOrg yourDockerRegistryOrganization yourDockerRegistryUsername yourDockerRegistryPassword yourDockerRegistryEmail</pre><p>Then Jenkins will be running on port <code class="literal">8080</code> and Artifactory <code class="literal">8081</code>.
The provided parameters will be passed as env variables to Jenkins VM
and credentials will be set in your set. That way you don&#8217;t have to do
any manual work on the Jenkins side. In the above parameters, the third parameter
could be yourForkedGithubOrg or yourGithubUsername. Also the <code class="literal">REPOS</code> env variable will
contain your GitHub org in which you have the forked repos.</p><p>You need to pass the credentials for the Docker organization (by default we will
search for the Docker images at Docker Hub) so that the pipeline will be able
to push images to your org.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="deploy-infra-k8s" href="#deploy-infra-k8s"></a>Deploy the infra JARs to Artifactory</h4></div></div></div><p><a name="jenkins-deploy-k8s" href="#jenkins-deploy-k8s"></a> When Artifactory is running, just execute the <code class="literal">tools/deploy-infra.sh</code> script from this repo.</p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/
./tools/deploy-infra-k8s.sh</pre><p>As a result both <code class="literal">eureka</code> and <code class="literal">stub runner</code> repos will be cloned, built,
uploaded to Artifactory and their docker images will be built.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Your local Docker process will be reused by the Jenkins instance running
in Docker. That&#8217;s why you don&#8217;t have to push these images to Docker Hub. On the
other hand if you run this sample in a remote Kubernetes cluster the driver
will not be shared by the Jenkins workers so you can consider pushing these
Docker images to Docker Hub too.</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_kubernetes_cli_installation" href="#_kubernetes_cli_installation"></a>6.1.3&nbsp;Kubernetes CLI Installation</h3></div></div></div><p>First you&#8217;ll need to install the <code class="literal">kubectl</code> CLI.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="kubernetes-cli-script" href="#kubernetes-cli-script"></a>Script Installation</h4></div></div></div><p>You can use the <code class="literal">tools/minikube-helper.sh</code> script to install <code class="literal">kubectl</code>. Just call</p><pre class="programlisting">$ ./tools/minikube-helper download-kubectl</pre><p>and then the <code class="literal">kubectl</code> will get downloaded</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="kubernetes-cli-manual" href="#kubernetes-cli-manual"></a>6.1.4&nbsp;Manual Installation</h3></div></div></div><p>Example for OSX</p><pre class="programlisting">$ curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl</pre><p>Example for Linux</p><pre class="programlisting">$ curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl</pre><p>Check out <a class="link" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_top">this page</a> for more information.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="start-minikube-k8s" href="#start-minikube-k8s"></a>6.1.5&nbsp;Kubernetes Cluster setup</h3></div></div></div><p>We need a cluster of Kubernetes. The best choice will be <a class="link" href="https://github.com/kubernetes/minikube" target="_top">Minikube</a>.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>You can skip this step if you have Kubernetes cluster installed and don&#8217;t
want to use Minikube The only thing you have to do is to set up spaces.</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>It&#8217;s more than likely that you&#8217;ll run out of resources when you reach stage step.
Don&#8217;t worry! Keep calm and <a class="link" href="">clear some apps from Minikube and continue</a>.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="kubernetes-minikube-script" href="#kubernetes-minikube-script"></a>Script Installation</h4></div></div></div><p>You can use the <code class="literal">tools/minikube-helper.sh</code> script to install <code class="literal">Minikube</code>. Just call</p><pre class="programlisting">$ ./tools/minikube-helper download-minikube</pre><p>and then the <code class="literal">Minikube</code> cluster will get downloaded</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="kubernetes-minikube-manual" href="#kubernetes-minikube-manual"></a>Manual Installation</h4></div></div></div><p>Example for OSX</p><pre class="programlisting">$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.<span class="hl-number">20.0</span>/minikube-darwin-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</pre><p>Feel free to leave off the <code class="literal">sudo mv minikube /usr/local/bin</code> if you would like to add minikube to your path manually.</p><p>Example for Linux</p><pre class="programlisting">$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.<span class="hl-number">20.0</span>/minikube-linux-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</pre><p>Feel free to leave off the <code class="literal">sudo mv minikube /usr/local/bin</code> if you would like to add minikube to your path manually.
Check out <a class="link" href="https://github.com/kubernetes/minikube/releases" target="_top">this page</a> for more info on the installation.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_run_minikube" href="#_run_minikube"></a>6.1.6&nbsp;Run Minikube</h3></div></div></div><p>Just type in <code class="literal">minikube start</code> to start Kubernetes on your local box.</p><p>To add the dashboard just execute <code class="literal">minikube dashboard</code></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_certificates_and_workers" href="#_certificates_and_workers"></a>6.1.7&nbsp;Certificates and Workers</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_minikube_certificates_and_workers" href="#_minikube_certificates_and_workers"></a>Minikube Certificates and Workers</h4></div></div></div><p>By default if you install Minikube all the certificates get installed in your
<code class="literal">~/.minikube</code> folder. Your <code class="literal">kubectl</code> configuration under <code class="literal">~/.kube/config</code> will also
get updated to use Minikube.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_manual_certificates_and_workers_setup" href="#_manual_certificates_and_workers_setup"></a>Manual Certificates and Workers Setup</h4></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>If you just want to run the default, demo setup you can skip this section</p></td></tr></table></div><p>To target a given Kubernetes instance one needs to pass around Certificate Authority
key and also user keys.</p><p>You can read more about the instructions on how to generate those keys <a class="link" href="https://coreos.com/kubernetes/docs/latest/openssl.html" target="_top">here</a>.
 Generally speaking if you have a Kubernetes installation (e.g. <code class="literal">minikube</code>) this step
 has already been done for you. Time to reuse those keys on the workers.</p><p>Extracted from the <a class="link" href="https://coreos.com/kubernetes/docs/latest/configure-kubectl.html" target="_top">official docs</a>.</p><p>Configure kubectl to connect to the target cluster using the following commands, replacing several values as indicated:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Replace <code class="literal">${MASTER_HOST}</code> with the master node address or name used in previous steps</li><li class="listitem">Replace <code class="literal">${CA_CERT}</code> with the absolute path to the ca.pem created in previous steps</li><li class="listitem">Replace <code class="literal">${ADMIN_KEY}</code> with the absolute path to the admin-key.pem created in previous steps</li><li class="listitem">Replace <code class="literal">${ADMIN_CERT}</code> with the absolute path to the admin.pem created in previous steps</li></ul></div><pre class="screen">$ kubectl config set-cluster default-cluster --server=https://${MASTER_HOST} --certificate-authority=${CA_CERT}
$ kubectl config set-credentials default-admin --certificate-authority=${CA_CERT} --client-key=${ADMIN_KEY} --client-certificate=${ADMIN_CERT}
$ kubectl config set-context default-system --cluster=default-cluster --user=default-admin
$ kubectl config use-context default-system</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_generate_minikube_namespaces" href="#_generate_minikube_namespaces"></a>6.1.8&nbsp;Generate Minikube namespaces</h3></div></div></div><p>With the running Minikube cluster we need to generate namespaces. Just execute the
<code class="literal">./tools/minikube-helper.sh setup-namespaces</code> to do this.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="docker-image-cf" href="#docker-image-cf"></a>6.2&nbsp;Docker Image</h2></div></div></div><p>If you would like to run the pre-configured Jenkins image somewhere other than your local machine, we
have an image you can pull and use on <a class="link" href="https://hub.docker.com/r/springcloud/spring-cloud-pipeline-jenkins/" target="_top">DockerHub</a>.
The <code class="literal">latest</code> tag corresponds to the latest snapshot build.  You can also find tags
corresponding to stable releases that you can use as well.</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="multi_jenkins-dsl-pipeline-cf.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="multi__the_demo_setup.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">5.&nbsp;Jenkins DSL Pipeline (Cloud Foundry)&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="multi_spring-cloud-pipelines.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;7.&nbsp;The demo setup</td></tr></table></div></body></html>